<div class="container p-3 pt-0 px-5" style="width: 100%;" *ngIf="displayForm">
    <div *ngIf="ticket?.status === TICKETSTATE.WORKINPROGRESS" class="d-flex justify-content-end align-items-center ">
        <button nz-button nzType="primary" (click)="saveStatus(TICKETSTATE.CLOSED)" >Close SWO Complete</button>
        <button class="mx-2 btn-outline-warning"  nz-button nzType="primary" (click)="saveStatus(TICKETSTATE.WAITFORCLOSURE)" >Close SWO Incomplete</button>
        <button [disabled]="ticket.status === TICKETSTATE.CANCEL || ticket.status === TICKETSTATE.CLOSED" nz-button nzType="default" nzDanger (click)="saveStatus(TICKETSTATE.CANCEL)" >Cancel SWO</button>
        <button  nz-button nzType="primary" class="ms-2" >
            <label for="ticket-image" style="display: block; width: 100%; height: 100%; cursor: pointer;">
                Upload
                <input id="ticket-image" type="file" style="visibility: hidden; width: 0; height: 0;" (change)="onFileSelected($event)" accept="image/*">
            </label>
        </button>
        
    </div>  
    <form style="width: 100%;" nz-form [formGroup]="alarmForm!" (ngSubmit)="submitForm()">
        <div class="text-end mb-2" style="margin-right: 60px;">
            <button *ngIf="!displaySubmit && ticket?.status === TICKETSTATE.ASSIGNED && this.currentUser && this.currentUser?.role !== ROLE.NOC" nz-button nzType="primary">Accept</button>
            <button *ngIf="displaySubmit" nz-button nzType="primary">Submit</button>  
        </div>
        <app-ticket-management-steper [status]="this.ticket?.status"></app-ticket-management-steper>
        <div class="d-flex justify-content-between mt-3">
            <div class="alarm-tiket-form-left">
                <nz-form-item>
                    <nz-form-label [nzSm]="10" [nzXs]="24" nzFor="number">Number</nz-form-label>
                    <nz-form-control [nzSm]="14" [nzXs]="24" nzErrorTip="The number is not valid">
                        <input nz-input id="number" formControlName="number"  />
                    </nz-form-control>
                </nz-form-item>

                <nz-form-item>
                    <nz-form-label [nzSpan]="10" nzRequired>Site</nz-form-label>
                    <nz-form-control [nzSm]="14" [nzXs]="24" nzErrorTip="The input is not valid">
                        <nz-input-group nzPrefixIcon="search">
                            <input type="text" nz-input [nzAutocomplete]="sites"
                                [ngModel]="alarmForm!.get('site')?.value?.siteId" [disabled]="this.ticket !== undefined"
                                [ngModelOptions]="{standalone: true}"
                                (ngModelChange)="onSiteInput($event)" 
                                [value]="alarmForm!.get('site')?.value?.siteId" placeholder="Search...">
                        </nz-input-group>
                        <nz-autocomplete #sites >
                            <nz-auto-option  *ngFor="let option of filteredSites" [nzValue]="option"
                                [nzLabel]="option.siteId">{{option.siteId}}</nz-auto-option>
                        </nz-autocomplete>
                    </nz-form-control>
                </nz-form-item>

                <nz-form-item>
                    <nz-form-label [nzSpan]="10">Site Access Request</nz-form-label>
                    <nz-form-control [nzSm]="14" [nzXs]="24" nzErrorTip="The input is not valid">
                        <nz-input-group nzPrefixIcon="search">
                            <input type="text" nz-input [nzAutocomplete]="siteAccessRequest"
                                formControlName="siteAccessRequest" placeholder="Search...">
                        </nz-input-group>
                        <nz-autocomplete #siteAccessRequest>
                            <nz-auto-option *ngFor="let option of filteredSiteAccessRequests" [nzValue]="option">{{
                                option }}</nz-auto-option>
                        </nz-autocomplete>
                    </nz-form-control>
                </nz-form-item>

                <nz-form-item>
                    <nz-form-label nzRequired [nzSpan]="10">Priority</nz-form-label>
                    <nz-form-control  [nzXs]="14" nzErrorTip="The input is not valid">
                        <nz-select name="select-validate" nzPlaceHolder="Priority" formControlName="priority">
                            <nz-option *ngFor="let p of priorities" [nzValue]="p" [nzLabel]="p.name">{{p.name}}</nz-option>
                        </nz-select>
                    </nz-form-control>
                </nz-form-item>

                <nz-form-item>
                    <nz-form-label [nzSpan]="10">Alarm Checklist</nz-form-label>
                    <nz-form-control [nzXs]="14" nzErrorTip="The input is not valid">
                        <label nz-checkbox formControlName="alarmChecklist"></label>
                    </nz-form-control>
                </nz-form-item>

                <nz-form-item>
                    <nz-form-label [nzSpan]="10">P0P4Tab</nz-form-label>
                    <nz-form-control [nzXs]="14" nzErrorTip="The input is not valid">
                        <label nz-checkbox formControlName="p0P4Tab"></label>
                    </nz-form-control>
                </nz-form-item>

                <nz-form-item>
                    <nz-form-label [nzSpan]="10">SWO auto Created</nz-form-label>
                    <nz-form-control [nzXs]="14" nzErrorTip="The input is not valid">
                        <label nz-checkbox formControlName="swoAutoCreated"></label>
                    </nz-form-control>
                </nz-form-item>

                <nz-form-item>
                    <nz-form-label [nzSpan]="10">Task Reference</nz-form-label>
                    <nz-form-control [nzSm]="14" [nzXs]="24" nzErrorTip="The input is not valid">
                        <nz-input-group nzPrefixIcon="search">
                            <input type="text" nz-input [nzAutocomplete]="taskRef" formControlName="taskReference"
                                placeholder="Search...">
                        </nz-input-group>
                        <nz-autocomplete #taskRef>
                            <nz-auto-option *ngFor="let option of filteredTaskRefs" [nzValue]="option">{{ option
                                }}</nz-auto-option>
                        </nz-autocomplete>
                    </nz-form-control>
                </nz-form-item>

                <nz-form-item>
                    <nz-form-label [nzSpan]="10" nzFor="datePicker">Actuel WO Date</nz-form-label>
                    <nz-form-control [nzSm]="14" [nzXs]="24">
                        <nz-date-picker style="width: 100%;" formControlName="woDate" nzFormat="yyyy-MM-dd"
                            nzShowTime></nz-date-picker>
                    </nz-form-control>
                </nz-form-item>
            </div>

            <div class="alarm-tiket-form-right">
                <nz-form-item>
                    <nz-form-label [nzSm]="10" [nzXs]="24" nzFor="state">State</nz-form-label>
                    <nz-form-control [nzSm]="14" [nzXs]="24" nzErrorTip="The input is not valid">
                        <input nz-input id="state" formControlName="state" />
                    </nz-form-control>
                </nz-form-item>

                <nz-form-item>
                    <nz-form-label [nzSpan]="10">Assignment group</nz-form-label>
                    <nz-form-control [nzSm]="14" [nzXs]="24" nzErrorTip="The input is not valid">
                        <nz-input-group nzPrefixIcon="search">
                            <input type="text" nz-input [nzAutocomplete]="assignmentGroup"
                            [disabled]="this.ticket !== undefined"
                            [ngModel]="alarmForm!.get('assignmentGroup')?.value?.name??''"
                            [ngModelOptions]="{standalone: true}"
                            (ngModelChange)="onAssignmentGroupInput($event)" 
                            [value]="alarmForm!.get('assignmentGroup')?.value?.name??''" placeholder="Search...">
                        </nz-input-group>
                        <nz-autocomplete #assignmentGroup>
                            <nz-auto-option *ngFor="let option of filteredAssignmentGroups" [nzValue]="option"
                                [nzLabel]="option.name">{{ option.name }}</nz-auto-option>
                        </nz-autocomplete>
                    </nz-form-control>
                </nz-form-item>

                <nz-form-item>
                    <nz-form-label [nzSpan]="10" nzRequired>Assigned to</nz-form-label>
                    <nz-form-control [nzSm]="14" [nzXs]="24" nzErrorTip="The input is not valid">
                        <nz-input-group nzPrefixIcon="search">
                            <input type="text" nz-input [nzAutocomplete]="assignedTo"
                            [disabled]="this.ticket !== undefined"
                            [ngModel]="alarmForm!.get('assignedTo')?.value?.firstName !== undefined ? alarmForm!.get('assignedTo')?.value?.firstName??'' +' '+ alarmForm?.get('assignedTo')?.value?.lastName??'':''"
                            [ngModelOptions]="{standalone: true}"
                            (ngModelChange)="onAssignedToInput($event)" 
                            [value]=" alarmForm!.get('assignedTo')?.value?.firstName !== undefined ? alarmForm!.get('assignedTo')?.value?.firstName??'' +' '+ alarmForm?.get('assignedTo')?.value?.lastName??'': ''" placeholder="Search...">
                        </nz-input-group>
                        <nz-autocomplete #assignedTo>
                            <nz-auto-option *ngFor="let option of filteredAssignedTo" [nzValue]="option"
                                [nzLabel]="option.firstName??'' +' '+ option.lastName??''">{{ option.firstName??'' +' '+ option.lastName??'' }}</nz-auto-option>
                        </nz-autocomplete>
                    </nz-form-control>
                </nz-form-item>

                <nz-form-item>
                    <nz-form-label [nzSm]="10" [nzXs]="24" nzFor="gpsLocation">GPS location</nz-form-label>
                    <nz-form-control [nzSm]="14" [nzXs]="24" nzErrorTip="The input is not valid">
                        <input nz-input id="gpsLocation" formControlName="gpsLocation" />
                    </nz-form-control>
                </nz-form-item>
            </div>
        </div>

        <div class="mt-2">
            <nz-form-item style="width: 100%;">
                <nz-form-label [nzSm]="4" nzFor="shortDescription">Short description</nz-form-label>
                <nz-form-control [nzSm]="24" [nzXs]="24" nzErrorTip="The input is not valid">
                    <input nz-input id="shortDescription" formControlName="shortDescription" />
                </nz-form-control>
            </nz-form-item>

            <nz-form-item style="width: 100%;">
                <nz-form-label [nzSm]="4" nzFor="partShortDescription">Part Short description</nz-form-label>
                <nz-form-control [nzSm]="24" [nzXs]="24" nzErrorTip="The input is not valid">
                    <input nz-input id="partShortDescription" formControlName="partShortDescription" />
                </nz-form-control>
            </nz-form-item>

            <nz-form-item style="width: 100%;">
                <nz-form-label [nzSm]="4" nzFor="description">Description</nz-form-label>
                <nz-form-control [nzSm]="24" [nzXs]="24" nzErrorTip="The input is not valid">
                    <textarea nz-input formControlName="description"
                        placeholder="Autosize height with minimum and maximum number of lines"
                        [nzAutosize]="{ minRows: 2, maxRows: 6 }"></textarea>
                </nz-form-control>
            </nz-form-item>

            <nz-form-item style="width: 100%;">
                <nz-form-label [nzSm]="4" nzFor="workNote">Work Note</nz-form-label>
                <nz-form-control [nzSm]="24" [nzXs]="24" nzErrorTip="The input is not valid">
                    <textarea nz-input formControlName="workNote"
                        placeholder="Autosize height with minimum and maximum number of lines"
                        [nzAutosize]="{ minRows: 2, maxRows: 6 }"></textarea>
                </nz-form-control>
            </nz-form-item>
        </div>
    </form>

    <div *ngIf="ticket">
         <div class="row">
             <div *ngFor="let doc of ticket.documents" class="col-12 mt-3">
                <div class="card">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center" >
                             <span>Uploaded by: {{doc.createdBy}}</span>
                             <span>Image uploaded: {{doc.createdAt | dateFormat}}</span>
                        </div>
                      </div>
                      <div class="card-body">
                        <img [src]="doc.imageData" class="img-fluid" style="height: 220px;" />
                      </div>
                </div>
                
             </div>
         </div>
    </div>
</div>
<app-ticket-task-list *ngIf="tasks.length > 0" [listOfTicketTasks]="tasks" [ticket]="ticket" ></app-ticket-task-list>
